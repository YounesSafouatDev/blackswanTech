version: "3.9"
services:
  web:
    image: odoo:17.0
    depends_on:
      - mydb
    ports:
      - "8099:8099"
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
    command: >
      bash -c "
      echo 'Waiting for PostgreSQL to be ready...';
      COUNT=0;
      while ! PGPASSWORD=${DB_PASSWORD} pg_isready -h ${DB_HOST} -p ${DB_PORT} -U ${DB_USER}; do
        sleep 2;
        COUNT=$((COUNT+1));
        if [ $COUNT -ge 30 ]; then
          echo 'Timeout waiting for PostgreSQL. Exiting...';
          exit 1;
        fi;
      done;
      echo 'PostgreSQL is ready. Starting Odoo...';
      odoo
      "
    volumes:
      - ./odoo.conf:/etc/odoo/odoo.conf
      - ./addons:/mnt/extra-addons
      - ./filestore:/var/lib/odoo/.local/share/Odoo/filestore
      - ./filestore/.local/share/Odoo/sessions:/var/lib/odoo/.local/share/Odoo/sessions
